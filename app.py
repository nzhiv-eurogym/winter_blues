import streamlit as st
from datetime import datetime

st.set_page_config(page_title="How to beat the winter blues", page_icon="‚ùÑÔ∏è", layout="centered")

st.title("‚ùÑÔ∏è How to beat the winter blues")
st.caption("–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —à–∫–∞–ª–µ 1‚Äì5 (1 ‚Äî –ª–æ–∂—å, 5 ‚Äî –∏—Å—Ç–∏–Ω–∞). –í –∫–æ–Ω—Ü–µ —Ç—ã –ø–æ–ª—É—á–∏—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —Å–æ–≤–µ—Ç—ã.")

st.info(
    "–ï—Å–ª–∏ —Ç–µ–±–µ –ø—Ä—è–º–æ —Ç—è–∂–µ–ª–æ –∏ —ç—Ç–æ –¥–ª–∏—Ç—Å—è –±–æ–ª—å—à–µ –ø–∞—Ä—ã –Ω–µ–¥–µ–ª—å ‚Äî —ç—Ç–æ –Ω–µ ¬´—Å–ª–∞–±–æ—Å—Ç—å¬ª. "
    "–ü–æ–≥–æ–≤–æ—Ä–∏ —Å –±–ª–∏–∑–∫–∏–º –≤–∑—Ä–æ—Å–ª—ã–º (—Ä–æ–¥–∏—Ç–µ–ª—å/—É—á–∏—Ç–µ–ª—å/–ø—Å–∏—Ö–æ–ª–æ–≥)."
)

QUESTIONS = [
    "–ú–Ω–µ –≤—Å–µ –≤—Ä–µ–º—è —Ö–æ—á–µ—Ç—Å—è –ø—Ä–∏–ª–µ—á—å.",
    "–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ –∏ —Ç–æ—Å–∫–ª–∏–≤–æ, –∫–æ–≥–¥–∞ —è –æ—Å–æ–∑–Ω–∞—é, —á—Ç–æ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –≤–æ–ª—à–µ–±—Å—Ç–≤–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –Ω—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –≤ —Ä–∞–±–æ—á–∏–π —Ä–∏—Ç–º.",
    "–Ø –±–µ–∑–¥—É–º–Ω–æ —Å–∏–∂—É –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –∞ –ø–æ—Ç–æ–º –∏—Å–ø—ã—Ç—ã–≤–∞—é —á—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã.",
    "–ú—ã—Å–ª—å –æ –ø—Ä–æ–≥—É–ª–∫–µ –≤ –º–æ—Ä–æ–∑–Ω—É—é –ø–æ–≥–æ–¥—É –≤—ã–∑—ã–≤–∞–µ—Ç –æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ.",
    "–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ —Ñ–∏–ª—å–º—ã –∏ —É–∫—Ä–∞—à–µ–Ω–∏—è –±–æ–ª—å—à–µ –º–µ–Ω—è –Ω–µ —Ä–∞–¥—É—é—Ç.",
    "–ú–Ω–µ –Ω–µ —Ö–æ—á–µ—Ç—Å—è –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –∏–ª–∏ –ø–æ–º–æ–≥–∞—Ç—å –≤ —Ä–∞–±–æ—Ç–µ –ø–æ –¥–æ–º—É.",
    "–ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –Ω–æ–≤—ã–π –≥–æ–¥ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ –∏ –±—É–¥–µ—Ç —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –∏ –ø—Ä–æ—à–ª—ã–π.",
    "–ü–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –∫–∞–Ω–∏–∫—É–ª —è –Ω–µ –≤–∏–∂—É —Å–º—ã—Å–ª–∞ –≤ –∑–∏–º–µ.",
    "–Ø –ù–ï —É–≤–µ—Ä–µ–Ω(–∞), —á—Ç–æ –±—ã–ª —á–µ—Å—Ç–µ–Ω/—á–µ—Å—Ç–Ω–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π.",
]

SCALE_HELP = "1 ‚Äî –ª–æ–∂—å ‚Ä¢ 2 ‚Äî —Å–∫–æ—Ä–µ–µ –ª–æ–∂—å ‚Ä¢ 3 ‚Äî –Ω–µ –∑–Ω–∞—é/50-50 ‚Ä¢ 4 ‚Äî —Å–∫–æ—Ä–µ–µ –∏—Å—Ç–∏–Ω–∞ ‚Ä¢ 5 ‚Äî –∏—Å—Ç–∏–Ω–∞"


def advice_for_score(total: int) -> tuple[str, str]:
    if 10 <= total <= 19:
        return (
            "üèÜ ¬´–¢—ã –º–æ–π –∫—É–º–∏—Ä¬ª",
            "- –°–æ–Ω –ø–æ —Ä–µ–∂–∏–º—É\n- –î–Ω–µ–≤–Ω–æ–π —Å–≤–µ—Ç —É—Ç—Ä–æ–º\n- –ú–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏ –≤ –ø–ª–∞–Ω–∞—Ö\n- –õ—ë–≥–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å",
        )
    elif 20 <= total <= 29:
        return (
            "üå§Ô∏è ¬´–î–µ—Ä–∂–∏—Å—å, –≤—Å–µ –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ!¬ª",
            "- –õ–µ—á—å –Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ\n- 10 –º–∏–Ω—É—Ç –¥–≤–∏–∂–µ–Ω–∏—è\n- 1 –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–µ–ª–æ –≤ –¥–µ–Ω—å\n- –¢–∞–π–º–µ—Ä –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏",
        )
    elif 30 <= total <= 39:
        return (
            "üß£ ¬´–í—Å—ë –Ω–µ —Ç–∞–∫ —É–∂ –∏ –ø–ª–æ—Ö–æ, –∫–∞–∫ —Ç–µ–±–µ –∫–∞–∂–µ—Ç—Å—è¬ª",
            "- –°–≤–µ—Ç —É—Ç—Ä–æ–º 5‚Äì10 –º–∏–Ω—É—Ç\n- –ü—Ä–æ–≥—É–ª–∫–∞ —Å–ª–æ—è–º–∏ + –º—É–∑—ã–∫–∞\n- –ú–∏–∫—Ä–æ-—Ä–∏—Ç—É–∞–ª (—á–∞–π + –ø–ª–∞–Ω)\n- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∞/–ø–æ–¥—Ä—É–≥–∏",
        )
    else:  # 40‚Äì50
        return (
            "ü§ç ¬´–Ø —Å —Ç–æ–±–æ–π!¬ª",
            "- 1% –¥–µ–π—Å—Ç–≤–∏—è (–≤–æ–¥–∞/—É–º—ã—Ç—å—Å—è)\n- –¢—ë–ø–ª–∞—è –µ–¥–∞ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–µ—Ä–µ–∫—É—Å\n- –î–µ–Ω—å –ø–æ –∫—É—Å–æ—á–∫–∞–º\n- –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –±–ª–∏–∑–∫–∏–º –≤–∑—Ä–æ—Å–ª—ã–º",
        )


def band_for_score(total: int) -> str:
    if 10 <= total <= 19:
        return "10‚Äì19"
    if 20 <= total <= 29:
        return "20‚Äì29"
    if 30 <= total <= 39:
        return "30‚Äì39"
    return "40‚Äì50"


# =========================
# Session state (–∞–Ω–æ–Ω–∏–º–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)
# =========================
if "results_history" not in st.session_state:
    # —Å–ø–∏—Å–æ–∫ –ø–æ–ø—ã—Ç–æ–∫ –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
    st.session_state.results_history = []

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å: –∏—Å—Ç–æ—Ä–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
with st.sidebar:
    st.header("üßæ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è (—ç—Ç–∞ —Å–µ—Å—Å–∏—è)")
    st.caption("–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –æ–∫–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞, –ø–æ–∫–∞ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ.")

    if st.session_state.results_history:
        st.write(f"–ü–æ–ø—ã—Ç–æ–∫: **{len(st.session_state.results_history)}**")
        last = st.session_state.results_history[-1]
        st.write(f"–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: **{last['total']}** ({last['band']})")
    else:
        st.write("–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.")

    if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"):
        st.session_state.results_history = []
        st.success("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.")

    st.divider()
    show_details = st.toggle("–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ–ø—ã—Ç–æ–∫", value=False)

st.divider()

# =========================
# –§–æ—Ä–º–∞
# =========================
with st.form("winter_blues_form"):
    st.subheader("–í–æ–ø—Ä–æ—Å—ã")
    st.caption(SCALE_HELP)

    answers = []
    for i, q in enumerate(QUESTIONS, start=1):
        val = st.slider(f"{i}. {q}", min_value=1, max_value=5, value=3, step=1)
        answers.append(val)

    submitted = st.form_submit_button("–ü–æ—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ")

# =========================
# –†–µ–∑—É–ª—å—Ç–∞—Ç + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ session_state
# =========================
if submitted:
    total = sum(answers)
    honesty = answers[-1]

    title, tips = advice_for_score(total)
    band = band_for_score(total)

    # –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∑–∞–ø–∏—Å—å (–±–µ–∑ –∏–º–µ–Ω–∏, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤)
    st.session_state.results_history.append(
        {
            "ts": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "total": total,
            "band": band,
            "title": title,
            # –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—É–º–º—ã –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º, –µ—Å–ª–∏ –Ω–∞–¥–æ:
            # "answers": answers,  # <- —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –æ—Ç–≤–µ—Ç—ã
        }
    )

    st.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç")
    st.metric("–¢–≤–æ–∏ –±–∞–ª–ª—ã", total)
    st.markdown(f"### {title}")
    st.markdown("**–°–æ–≤–µ—Ç—ã:**\n" + tips)

    if honesty >= 4:
        st.warning(
            "–ü–æ—Ö–æ–∂–µ, —Ç—ã —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è, —á—Ç–æ –æ—Ç–≤–µ—á–∞–ª(–∞) —á–µ—Å—Ç–Ω–æ. "
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑ –≤ —Å–ø–æ–∫–æ–π–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ üôÇ"
        )

    st.markdown(
        """
**–° –ª—é–±–æ–≤—å—é,  
–õ–µ—Ç–æ** ‚òÄÔ∏è
"""
    )

st.divider()

# =========================
# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
# =========================
if st.session_state.results_history:
    st.subheader("üìä –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫ (—ç—Ç–∞ —Å–µ—Å—Å–∏—è)")
    if show_details:
        for idx, r in enumerate(reversed(st.session_state.results_history), start=1):
            st.write(f"**#{idx}** ‚Ä¢ {r['ts']} ‚Ä¢ **{r['total']}** –±–∞–ª–ª–æ–≤ ‚Ä¢ {r['band']} ‚Ä¢ {r['title']}")
    else:
        # –∫–æ–º–ø–∞–∫—Ç–Ω–æ: —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5
        for r in st.session_state.results_history[-5:]:
            st.write(f"{r['ts']} ‚Äî **{r['total']}** ({r['band']})")
